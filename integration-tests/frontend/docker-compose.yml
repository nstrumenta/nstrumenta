version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - API_URL=${API_URL:-http://nstrumenta-server:5999}
      - FRONTEND_URL=${FRONTEND_URL:-http://frontend-app:4200}
      - TEST_ID=${TEST_ID}
      - NSTRUMENTA_API_KEY=${NSTRUMENTA_API_KEY}
      - TEST_USER_EMAIL=${TEST_USER_EMAIL}
      - TEST_USER_PASSWORD=${TEST_USER_PASSWORD}
    command: npm run test:all
    depends_on:
      server:
        condition: service_healthy
      frontend-app:
        condition: service_started
    networks:
      - nstrumenta_default

  frontend-app:
    build:
      context: ../..
      dockerfile: ./integration-tests/frontend/frontend-serve.Dockerfile
    environment:
      - PORT=4200
      - API_URL=${API_URL:-http://nstrumenta-server:5999}
    networks:
      - nstrumenta_default
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4200"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 5s

  server:
    container_name: nstrumenta-server
    build:
      context: ../..
      dockerfile: ./server/Dockerfile
    environment:
      - CI=${CI}
      - TEST_ID=${TEST_ID}
      - NSTRUMENTA_CLOUD_RUN_MODE=${NSTRUMENTA_CLOUD_RUN_MODE}
      # Server expects GCLOUD_SERVICE_KEY, map from NST_CI_SERVICE_KEY
      - GCLOUD_SERVICE_KEY=${NST_CI_SERVICE_KEY}
      - NSTRUMENTA_API_KEY_PEPPER=${NSTRUMENTA_API_KEY_PEPPER}
      - FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - FIREBASE_APP_ID=${FIREBASE_APP_ID}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - nstrumenta_default
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5999/health').then(() => process.exit(0)).catch(() => process.exit(1))"]
      interval: 1s
      timeout: 3s
      retries: 30
      start_period: 5s

networks:
  nstrumenta_default:
    external: true

